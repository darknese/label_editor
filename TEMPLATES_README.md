# Функциональность сохранения шаблонов

## Обзор

Система сохранения шаблонов позволяет пользователям сохранять, загружать, редактировать и экспортировать шаблоны дизайнов. Шаблоны включают в себя все элементы на холсте, их свойства и связанные изображения.

## Основные возможности

### 1. Сохранение шаблонов
- **Кнопка**: "Сохранить шаблон" в верхней панели
- **Функция**: Сохраняет текущее состояние холста как шаблон
- **Поля**:
  - Название шаблона (обязательное, минимум 3 символа)
  - Описание (необязательное)
- **Данные**: Сохраняются все элементы, их свойства, размер холста и ссылки на изображения

### 2. Загрузка шаблонов
- **Панель**: "Шаблоны" в левой панели инструментов
- **Функция**: Отображает список сохраненных шаблонов
- **Действия**:
  - Применить шаблон
  - Редактировать шаблон
  - Удалить шаблон

### 3. Редактирование шаблонов
- **Кнопка**: Иконка редактирования в списке шаблонов
- **Функция**: Изменение названия и описания шаблона
- **Ограничения**: Только владелец может редактировать свои шаблоны

### 4. Удаление шаблонов
- **Кнопка**: Иконка удаления в списке шаблонов
- **Функция**: Удаление шаблона с подтверждением
- **Ограничения**: Только владелец может удалять свои шаблоны

### 5. Экспорт шаблонов
- **Кнопка**: "Экспорт JSON" в верхней панели
- **Функция**: Экспорт шаблона в JSON файл
- **Опции**:
  - Включение/исключение ссылок на изображения
- **Формат**: JSON файл с полной структурой шаблона

### 6. Импорт шаблонов
- **Кнопка**: "Импорт JSON" в верхней панели
- **Функция**: Импорт шаблона из JSON файла
- **Валидация**: Проверка структуры файла
- **Совместимость**: Поддержка экспортированных файлов

## Структура данных

### Template (Тип)
```typescript
type Template = {
  id: string;
  name: string;
  description?: string;
  data: any;
  userId: string;
  createdAt: string;
  updatedAt: string;
};
```

### TemplateResponse (Тип)
```typescript
type TemplateResponse = {
  template: Template;
  fileUrls: Record<string, string>; // fileId → presignedUrl
};
```

## API Endpoints

### POST /templates
- **Назначение**: Создание нового шаблона
- **Тело запроса**:
  ```json
  {
    "name": "string",
    "description": "string (optional)",
    "data": {
      "elements": [...],
      "canvasSize": {...}
    },
    "imageIds": ["string"]
  }
  ```

### GET /templates
- **Назначение**: Получение списка шаблонов пользователя
- **Ответ**: Массив шаблонов

### GET /templates/:id
- **Назначение**: Получение конкретного шаблона с presigned URLs
- **Ответ**: TemplateResponse

### PUT /templates/:id
- **Назначение**: Обновление шаблона
- **Тело запроса**:
  ```json
  {
    "name": "string",
    "description": "string (optional)"
  }
  ```

### DELETE /templates/:id
- **Назначение**: Удаление шаблона

## Компоненты

### SaveTemplateDialog
- Диалог сохранения шаблона
- Валидация названия
- Поле для описания
- Обработка ошибок

### ExportTemplateDialog
- Диалог экспорта шаблона
- Выбор названия файла
- Опция включения изображений
- Скачивание JSON файла

### ImportTemplateDialog
- Диалог импорта шаблона
- Валидация JSON файла
- Предварительный просмотр данных
- Загрузка в редактор

### TemplatesToolPanel
- Панель управления шаблонами
- Список шаблонов
- Действия: применить, редактировать, удалить
- Обработка ошибок

## Обработка изображений

### Сохранение
- Изображения сохраняются в MinIO
- В шаблоне сохраняются fileId и presigned URLs
- При сохранении шаблона создаются связи с файлами

### Загрузка
- При загрузке шаблона генерируются новые presigned URLs
- Изображения отображаются через presigned URLs
- Поддержка обратной совместимости (поле src)

## Безопасность

### Авторизация
- Все операции требуют JWT токен
- Пользователи могут работать только со своими шаблонами
- Проверка прав доступа на сервере

### Валидация
- Проверка названия шаблона (минимум 3 символа)
- Валидация структуры JSON при импорте
- Проверка существования файлов

## Обработка ошибок

### Клиентская часть
- Отображение ошибок в диалогах
- Автоматическое скрытие ошибок
- Валидация форм

### Серверная часть
- Логирование ошибок
- Возврат понятных сообщений об ошибках
- Обработка сетевых ошибок

## Использование

### Сохранение шаблона
1. Создайте дизайн на холсте
2. Нажмите "Сохранить шаблон"
3. Введите название и описание
4. Нажмите "Сохранить"

### Загрузка шаблона
1. Откройте панель "Шаблоны"
2. Найдите нужный шаблон
3. Нажмите "Применить"

### Экспорт шаблона
1. Нажмите "Экспорт JSON"
2. Введите название файла
3. Выберите опции
4. Нажмите "Экспортировать"

### Импорт шаблона
1. Нажмите "Импорт JSON"
2. Выберите JSON файл
3. Проверьте информацию
4. Нажмите "Импортировать"

## Технические детали

### Состояние редактора
- `elements`: Массив элементов на холсте
- `fileUrls`: Карта fileId → presignedUrl
- `CANVAS_SIZE`: Размеры холста

### Персистентность
- Состояние редактора сохраняется в localStorage
- Шаблоны сохраняются в базе данных
- Изображения хранятся в MinIO

### Производительность
- Ленивая загрузка шаблонов
- Кэширование presigned URLs
- Оптимизированные запросы к API 